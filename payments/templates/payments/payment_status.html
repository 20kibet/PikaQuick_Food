{% extends 'base.html' %}
{% load static %}

{% block title %}Payment Status - PikaQuick{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-body text-center">
                    <!-- Pending State -->
                    <div id="pendingState" {% if payment.status != 'pending' %}style="display: none;"{% endif %}>
                        <div class="spinner-border text-warning mb-3" role="status" style="width: 4rem; height: 4rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h4 class="text-warning">
                            <i class="bi bi-clock-history"></i> Waiting for Payment
                        </h4>
                        <p class="text-muted">Please complete the payment on your phone</p>
                        <div class="alert alert-info">
                            Check your phone for the M-Pesa prompt and enter your PIN
                        </div>
                    </div>

                    <!-- Success State -->
                    <div id="successState" {% if payment.status != 'completed' %}style="display: none;"{% endif %}>
                        <div class="text-success mb-3">
                            <i class="bi bi-check-circle-fill" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-success">Payment Successful!</h4>
                        <p class="text-muted">Your order has been confirmed</p>
                        
                        {% if payment.mpesa_receipt_number %}
                        <div class="alert alert-success">
                            <strong>M-Pesa Receipt:</strong><br>
                            {{ payment.mpesa_receipt_number }}
                        </div>
                        {% endif %}

                        <a href="{% url 'home' %}" class="btn btn-primary mt-3">
                            <i class="bi bi-house"></i> Back to Home
                        </a>
                    </div>

                    <!-- Failed State -->
                    <div id="failedState" {% if payment.status != 'failed' %}style="display: none;"{% endif %}>
                        <div class="text-danger mb-3">
                            <i class="bi bi-x-circle-fill" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-danger">Payment Failed</h4>
                        <p class="text-muted">{{ payment.result_desc|default:"The payment could not be completed" }}</p>
                        
                        <a href="{% url 'payments:initiate_payment' %}" class="btn btn-warning mt-3">
                            <i class="bi bi-arrow-clockwise"></i> Try Again
                        </a>
                    </div>

                    <!-- Payment Details -->
                    <div class="mt-4 pt-4 border-top">
                        <div class="row text-start">
                            <div class="col-6">
                                <small class="text-muted">Phone Number:</small><br>
                                <strong>{{ payment.phone_number }}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Amount:</small><br>
                                <strong class="text-success">KES {{ payment.amount|floatformat:2 }}</strong>
                            </div>
                        </div>
                        <div class="row text-start mt-3">
                            <div class="col-12">
                                <small class="text-muted">Transaction Date:</small><br>
                                <strong>{{ payment.created_at|date:"M d, Y - H:i" }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Card -->
            <div class="card mt-3">
                <div class="card-body text-center">
                    <small class="text-muted">
                        Need help? Contact support at <strong>support@pikaquick.com</strong>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh payment status every 3 seconds for pending payments
const paymentStatus = "{{ payment.status }}";

if (paymentStatus === 'pending') {
    let checkCount = 0;
    const maxChecks = 40; // Check for 2 minutes (40 * 3 seconds)

    const statusChecker = setInterval(async () => {
        checkCount++;
        
        if (checkCount > maxChecks) {
            clearInterval(statusChecker);
            return;
        }
        
        try {
            const response = await fetch('{% url "payments:check_payment_status" payment.id %}');
            const data = await response.json();
            
            if (data.status === 'completed') {
                clearInterval(statusChecker);
                document.getElementById('pendingState').style.display = 'none';
                document.getElementById('successState').style.display = 'block';
                
                // Update receipt number if available
                if (data.mpesa_receipt) {
                    const receiptDiv = document.createElement('div');
                    receiptDiv.className = 'alert alert-success';
                    receiptDiv.innerHTML = `<strong>M-Pesa Receipt:</strong><br>${data.mpesa_receipt}`;
                    document.getElementById('successState').appendChild(receiptDiv);
                }
                
            } else if (data.status === 'failed') {
                clearInterval(statusChecker);
                document.getElementById('pendingState').style.display = 'none';
                document.getElementById('failedState').style.display = 'block';
            }
        } catch (error) {
            console.error('Error checking status:', error);
        }
    }, 3000);
}
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}